# PDF预览与打印功能打包指南

## 📋 功能说明

### PDF预览功能特点:
- ✅ **精确预览**: 使用真实PDF生成,100%准确
- ✅ **强制预览**: 用户必须先生成预览才能生成PDF或打印
- ✅ **参数监控**: 参数改变时自动禁用生成按钮,提示重新预览
- ✅ **无硬编码**: 所有文本通过多语言字典实现
- ✅ **双语支持**: 中文/泰语完整支持

### 新增打印功能特点:
- ✅ **PDF转PNG打印**: 将PDF转换为高分辨率PNG后打印,解决PDF直接打印的兼容性问题
- ✅ **300 DPI高质量**: 使用300 DPI分辨率确保打印质量
- ✅ **自动清理**: 打印后5秒自动删除临时PNG文件
- ✅ **Windows原生支持**: 使用`os.startfile()`调用Windows打印对话框
- ✅ **用户友好**: 显示准备打印和打印完成的提示信息

## 🔧 依赖库

新增依赖:
```bash
pip install PyMuPDF
```

完整依赖列表:
- PyQt6
- Pillow
- reportlab
- PyMuPDF (新增)

## 📦 打包步骤

### 1. 安装依赖

```bash
# 安装所有必需的库
pip install PyQt6 Pillow reportlab PyMuPDF
```

### 2. 安装PyInstaller

```bash
pip install pyinstaller
```

### 3. 打包命令

使用以下命令打包程序:

```bash
pyinstaller --name="标签打印工具" --windowed --onefile --icon=label.ico --add-data="label.ico;." --add-data="label.png;." label_gui_qt.py
```

**参数说明:**
- `--name="标签打印工具"`: 设置程序名称
- `--windowed`: 不显示控制台窗口
- `--onefile`: 打包成单个exe文件
- `--icon=label.ico`: 设置程序图标
- `--add-data="label.ico;."`: 包含图标文件
- `--add-data="label.png;."`: 包含PNG图标文件

### 4. 查找生成的EXE

打包完成后,在 `dist` 文件夹中找到 `标签打印工具.exe`

## 🎯 使用流程

### 用户操作流程:

1. **选择图片** → "生成预览"按钮启用
2. **点击"生成预览"** → 显示PDF预览 → "生成PDF"和"生成并打印"按钮启用
3. **修改参数** → "生成PDF"和"生成并打印"按钮禁用 → 提示"参数已改变,请重新生成预览"
4. **重新生成预览** → 所有按钮恢复可用

### 打印流程详解:

1. **点击"生成并打印"按钮**
2. **显示"正在准备打印..."提示**
3. **后台处理**:
   - 生成PDF文件(保存到本地)
   - 将PDF转换为300 DPI的PNG图片
   - 保存临时PNG文件
4. **显示"打印准备完成"提示**
5. **自动弹出Windows打印对话框**
6. **用户选择打印机并确认打印**
7. **5秒后自动删除临时PNG文件**

### 按钮状态逻辑:

| 状态 | 预览按钮 | 生成PDF按钮 | 生成并打印按钮 |
|------|---------|------------|---------------|
| 未选择图片 | ❌ 禁用 | ❌ 禁用 | ❌ 禁用 |
| 已选择图片 | ✅ 启用 | ❌ 禁用 | ❌ 禁用 |
| 已生成预览 | ✅ 启用 | ✅ 启用 | ✅ 启用 |
| 参数已改变 | ✅ 启用 | ❌ 禁用 | ❌ 禁用 |

## 🐛 常见问题

### Q1: 打包后运行提示缺少模块?
**A:** 确保所有依赖都已安装:
```bash
pip install PyQt6 Pillow reportlab PyMuPDF
```

### Q2: 预览显示不清晰?
**A:** 代码中使用了3倍分辨率渲染,确保清晰度。如需调整,修改 `generate_preview()` 函数中的 `zoom = 3`

### Q3: 打包后文件太大?
**A:** PyMuPDF库较大(约18MB),这是正常的。如需减小体积,可以考虑使用 `--onedir` 模式

### Q4: 图标没有显示?
**A:** 确保 `label.ico` 和 `label.png` 文件在项目根目录,并且打包命令中包含了 `--add-data` 参数

### Q5: 点击打印后没有反应?
**A:** 检查以下几点:
- 确保系统已安装打印机驱动
- 确保已生成预览(打印按钮才会启用)
- 检查是否有临时PNG文件生成失败的错误提示

### Q6: 临时PNG文件没有自动删除?
**A:** 临时文件会在5秒后自动删除。如果文件被占用(如打印对话框仍在使用),删除可能失败,这是正常的。可以手动删除 `label_print_temp_*.png` 文件

### Q7: 打印质量不够清晰?
**A:** 当前使用300 DPI,已经是高质量打印标准。如需更高质量,可以修改代码中的 `zoom = 300 / 72` 为更大的值,如 `zoom = 600 / 72`

## 📝 技术细节

### PDF预览实现原理:

1. **生成临时PDF**: 使用真实参数调用 `tile_label_image_to_pdf()` 生成临时PDF
2. **PDF转图片**: 使用PyMuPDF将PDF第一页转换为高分辨率图片(3倍缩放)
3. **显示预览**: 将图片缩放到预览区域大小并显示
4. **清理资源**: 关闭PDF文档并删除临时文件

### PDF转PNG打印实现原理:

1. **生成PDF**: 调用 `tile_label_image_to_pdf()` 生成PDF文件并保存
2. **PDF转PNG**: 使用PyMuPDF以300 DPI分辨率将PDF转换为PNG
   - 计算缩放比例: `zoom = 300 / 72` (约4.17倍)
   - 应用矩阵变换生成高分辨率图片
3. **保存临时文件**: PNG文件命名为 `label_print_temp_{timestamp}.png`
4. **调用打印**: 使用 `os.startfile(png_path, "print")` 打开Windows打印对话框
5. **后台清理**: 启动守护线程,延迟5秒后删除临时PNG文件

### 为什么使用PNG而不是直接打印PDF?

- **兼容性问题**: Windows的 `os.startfile(pdf_path, "print")` 会打开默认PDF阅读器而不是直接打印
- **用户体验**: PNG格式Windows原生支持,打印对话框直接显示,无需额外软件
- **打印质量**: 300 DPI确保打印质量,与PDF打印效果一致

### 关键代码位置:

- **预览生成**: `generate_preview()` 函数 (第785-853行)
- **打印功能**: `generate_and_print_pdf()` 函数 (第935-1025行)
- **按钮状态管理**: `update_button_states()` 函数 (第774-783行)
- **参数监听**: `on_parameter_changed()` 函数 (第765-772行)
- **多语言文本**: `LANGUAGES` 字典 (第28-111行)

## ✅ 验证清单

打包前检查:
- [ ] 所有依赖已安装 (PyQt6, Pillow, reportlab, PyMuPDF)
- [ ] PyMuPDF版本正确 (1.26.5+)
- [ ] 图标文件存在 (label.ico, label.png)
- [ ] 代码无语法错误
- [ ] 测试过预览功能
- [ ] 测试过打印功能

打包后测试:
- [ ] 程序能正常启动
- [ ] 图标正确显示
- [ ] 能选择图片
- [ ] 预览功能正常(显示清晰的PDF预览)
- [ ] 参数改变后按钮状态正确(禁用生成和打印按钮)
- [ ] 重新生成预览后按钮恢复可用
- [ ] 能生成PDF文件
- [ ] **打印功能正常**:
  - [ ] 点击"生成并打印"显示准备提示
  - [ ] 自动弹出Windows打印对话框
  - [ ] 能看到PNG预览图
  - [ ] 能成功打印
  - [ ] 临时PNG文件在5秒后自动删除
- [ ] 语言切换正常(中文/泰语)
- [ ] 参数设置能自动保存和加载

## 🎉 完成!

按照以上步骤,你就可以成功打包带有PDF预览和PNG打印功能的标签打印工具了!

### 核心改进总结:

1. **PDF预览**: 使用PyMuPDF实现精确的PDF预览,100%还原最终效果
2. **PNG打印**: 解决PDF直接打印的兼容性问题,使用300 DPI高质量PNG打印
3. **自动清理**: 后台线程自动清理临时文件,不影响用户体验
4. **用户友好**: 完整的提示信息和按钮状态管理,操作流程清晰
5. **多语言支持**: 中文/泰语完整支持,所有文本无硬编码

### 技术亮点:

- ✨ 使用PyMuPDF实现PDF↔PNG双向转换
- ✨ 300 DPI高分辨率确保打印质量
- ✨ 守护线程实现异步文件清理
- ✨ Windows原生打印对话框集成
- ✨ 完善的错误处理和用户提示