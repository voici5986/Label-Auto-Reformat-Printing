name: æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: å®‰è£… Poetry
      run: pipx install poetry

    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'poetry'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        poetry install
        poetry run pip install pyinstaller
    
    - name: è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·ï¼ˆä» tag æå–ï¼‰
      run: |
        # ä» tag æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰å¼€å¤´çš„ vï¼‰
        $tagName = "${{ github.ref_name }}"
        $version = $tagName -replace '^v', ''
        
        Write-Host "ğŸ“Œ Tag: $tagName"
        Write-Host "ğŸ“Œ æå–çš„ç‰ˆæœ¬å·: $version"
        
        # è¯»å–åŸæœ‰çš„ __version__.py
        $versionFile = Get-Content "__version__.py" -Raw
        
        # æ›¿æ¢ç‰ˆæœ¬å·
        $versionFile = $versionFile -replace '__version__ = ".*"', "__version__ = `"$version`""
        
        # å†™å›æ–‡ä»¶
        $versionFile | Set-Content "__version__.py" -NoNewline
        
        Write-Host "âœ… ç‰ˆæœ¬å·å·²è‡ªåŠ¨æ›´æ–°ä¸º: $version"
        
        # æ˜¾ç¤ºæ›´æ–°åçš„å†…å®¹
        Write-Host "`næ›´æ–°åçš„ __version__.py:"
        Get-Content "__version__.py"
      shell: pwsh
    
    - name: åŠ¨æ€ç”Ÿæˆ PyInstaller spec æ–‡ä»¶
      run: |
        $specContent = @"
        # -*- mode: python ; coding: utf-8 -*-

        block_cipher = None

        datas = [
            ('label.ico', '.'),
            ('label.png', '.'),
        ]

        hiddenimports = ['PIL._tkinter_finder']

        excludes = [
            'tkinter', 'matplotlib', 'numpy', 'pandas', 'scipy',
            'IPython', 'notebook', 'pytest', 'unittest', 'setuptools', 'distutils',
            'PyQt6.QtWebEngine', 'PyQt6.QtWebEngineCore', 'PyQt6.QtWebEngineWidgets',
            'PyQt6.QtMultimedia', 'PyQt6.QtMultimediaWidgets',
            'PyQt6.Qt3D', 'PyQt6.QtQuick', 'PyQt6.QtQml',
            'PyQt6.QtBluetooth', 'PyQt6.QtNfc', 'PyQt6.QtPositioning', 'PyQt6.QtSensors',
            'xml.etree', 'pydoc', 'doctest', '_pytest', 'test', 'tests',
        ]

        a = Analysis(
            ['label_gui_qt.py'],
            pathex=[],
            binaries=[],
            datas=datas,
            hiddenimports=hiddenimports,
            hookspath=[],
            hooksconfig={},
            runtime_hooks=[],
            excludes=excludes,
            win_no_prefer_redirects=False,
            win_private_assemblies=False,
            cipher=block_cipher,
            noarchive=False,
            optimize=2,
        )

        pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

        exe = EXE(
            pyz,
            a.scripts,
            [],
            exclude_binaries=True,
            name='Label-Auto-Reformat-Printing',
            debug=False,
            bootloader_ignore_signals=False,
            strip=False,
            upx=True,
            console=False,
            disable_windowed_traceback=False,
            argv_emulation=False,
            target_arch=None,
            codesign_identity=None,
            entitlements_file=None,
            icon=['label.ico'],
        )

        coll = COLLECT(
            exe,
            a.binaries,
            a.datas,
            strip=False,
            upx=True,
            upx_exclude=[],
            name='Label-Auto-Reformat-Printing',
        )
        "@
        
        $specContent | Out-File -FilePath "label_bundle.spec" -Encoding UTF8
        Write-Host "âœ… spec æ–‡ä»¶å·²ç”Ÿæˆ"
      shell: pwsh
    
    - name: ä½¿ç”¨ PyInstaller æ‰“åŒ…
      run: |
        # ä½¿ç”¨ poetry run è°ƒç”¨ç¯å¢ƒä¸­çš„ pyinstaller
        poetry run pyinstaller label_bundle.spec
    
    - name: å‹ç¼©æ‰“åŒ…æ–‡ä»¶
      run: |
        cd dist
        Compress-Archive -Path "Label-Auto-Reformat-Printing" -DestinationPath "Label-Auto-Reformat-Printing-Windows-x64.zip"
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Backup)
      uses: actions/upload-artifact@v4
      with:
        name: Label-Auto-Reformat-Printing-Windows-x64
        path: dist/Label-Auto-Reformat-Printing-Windows-x64.zip
        retention-days: 5
    
    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        $version = "${{ github.ref_name }}"
        echo "version=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
    
    - name: ä» CHANGELOG æå–æ›´æ–°å†…å®¹
      id: changelog
      run: |
        $version = "${{ github.ref_name }}"
        $versionNum = $version -replace '^v', ''
        
        # è¯»å– CHANGELOG.md
        $changelog = Get-Content "CHANGELOG.md" -Raw
        
        # æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹
        $pattern = "(?s)## \[$versionNum\].*?\n(.*?)(?=\n---|\n## \[|$)"
        if ($changelog -match $pattern) {
            $versionNotes = $matches[1].Trim()
            
            # å¦‚æœæå–æˆåŠŸï¼Œä½¿ç”¨æå–çš„å†…å®¹
            if ($versionNotes) {
                Write-Host "âœ… æˆåŠŸä» CHANGELOG.md æå–ç‰ˆæœ¬ $versionNum çš„æ›´æ–°å†…å®¹"
                
                # è½¬æ¢ä¸º GitHub Actions è¾“å‡ºæ ¼å¼ï¼ˆå¤šè¡Œæ–‡æœ¬ï¼‰
                $delimiter = "EOF-CHANGELOG-$(Get-Random)"
                echo "notes<<$delimiter" >> $env:GITHUB_OUTPUT
                echo $versionNotes >> $env:GITHUB_OUTPUT
                echo $delimiter >> $env:GITHUB_OUTPUT
                
                echo "found=true" >> $env:GITHUB_OUTPUT
            } else {
                Write-Host "âš ï¸ æœªæ‰¾åˆ°ç‰ˆæœ¬ $versionNum çš„æ›´æ–°å†…å®¹ï¼Œå°†ä½¿ç”¨é»˜è®¤è¯´æ˜"
                echo "found=false" >> $env:GITHUB_OUTPUT
            }
        } else {
            Write-Host "âš ï¸ CHANGELOG.md ä¸­æœªæ‰¾åˆ°ç‰ˆæœ¬ $versionNumï¼Œå°†ä½¿ç”¨é»˜è®¤è¯´æ˜"
            echo "found=false" >> $env:GITHUB_OUTPUT
        }
      shell: pwsh
    
    - name: åˆ›å»º Release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/Label-Auto-Reformat-Printing-Windows-x64.zip
        body: |
          ## ğŸ·ï¸ æ ‡ç­¾æ‰“å°å·¥å…· | Label Auto Reformat Printing ${{ steps.get_version.outputs.version }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜ | Download Instructions
          - **Windows ç”¨æˆ·**ï¼šä¸‹è½½ `Label-Auto-Reformat-Printing-Windows-x64.zip` å¹¶è§£å‹
          - **Windows Users**: Download `Label-Auto-Reformat-Printing-Windows-x64.zip` and extract
          - è§£å‹åè¿è¡Œ `Label-Auto-Reformat-Printing.exe` å³å¯ä½¿ç”¨
          - Run `Label-Auto-Reformat-Printing.exe` after extraction
          
          ---
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹ | What's Changed
          
          ${{ steps.changelog.outputs.found == 'true' && steps.changelog.outputs.notes || 'è¯·æŸ¥çœ‹ CHANGELOG.md äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹' }}
          
          ---
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½ | Key Features
          - ğŸ¨ Material Design é£æ ¼ç•Œé¢
          - ğŸŒ æ”¯æŒä¸­æ–‡/æ³°è¯­åŒè¯­ | Chinese/Thai bilingual support
          - ï¿½ PDF é¢„è§ˆå’Œç”Ÿæˆ | PDF preview and generation
          - ğŸ’¾ å‚æ•°è‡ªåŠ¨ä¿å­˜ | Auto-save settings
          - ğŸ­ ç²¾è‡´çš„åŠ è½½åŠ¨ç”» | Elegant loading animations
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
