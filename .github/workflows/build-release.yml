name: 构建和发布

on:
  push:
    tags:
      - 'v*'  # 当推送 v 开头的 tag 时触发（如 v1.0.0）

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置 Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip wheel
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: 动态生成 PyInstaller spec 文件
      run: |
        $specContent = @"
        # -*- mode: python ; coding: utf-8 -*-

        block_cipher = None

        datas = [
            ('label.ico', '.'),
            ('label.png', '.'),
        ]

        hiddenimports = ['PIL._tkinter_finder']

        excludes = [
            'tkinter', 'matplotlib', 'numpy', 'pandas', 'scipy',
            'IPython', 'notebook', 'pytest', 'unittest', 'setuptools', 'distutils',
            'PyQt6.QtWebEngine', 'PyQt6.QtWebEngineCore', 'PyQt6.QtWebEngineWidgets',
            'PyQt6.QtMultimedia', 'PyQt6.QtMultimediaWidgets',
            'PyQt6.Qt3D', 'PyQt6.QtQuick', 'PyQt6.QtQml',
            'PyQt6.QtBluetooth', 'PyQt6.QtNfc', 'PyQt6.QtPositioning', 'PyQt6.QtSensors',
            'xml.etree', 'pydoc', 'doctest', '_pytest', 'test', 'tests',
        ]

        a = Analysis(
            ['label_gui_qt.py'],
            pathex=[],
            binaries=[],
            datas=datas,
            hiddenimports=hiddenimports,
            hookspath=[],
            hooksconfig={},
            runtime_hooks=[],
            excludes=excludes,
            win_no_prefer_redirects=False,
            win_private_assemblies=False,
            cipher=block_cipher,
            noarchive=False,
            optimize=2,
        )

        pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

        exe = EXE(
            pyz,
            a.scripts,
            [],
            exclude_binaries=True,
            name='标签打印工具',
            debug=False,
            bootloader_ignore_signals=False,
            strip=False,
            upx=True,
            console=False,
            disable_windowed_traceback=False,
            argv_emulation=False,
            target_arch=None,
            codesign_identity=None,
            entitlements_file=None,
            icon=['label.ico'],
        )

        coll = COLLECT(
            exe,
            a.binaries,
            a.datas,
            strip=False,
            upx=True,
            upx_exclude=[],
            name='标签打印工具',
        )
        "@
        
        $specContent | Out-File -FilePath "label_bundle.spec" -Encoding UTF8
        Write-Host "✅ spec 文件已生成"
      shell: pwsh
    
    - name: 使用 PyInstaller 打包
      run: |
        pyinstaller label_bundle.spec
    
    - name: 压缩打包文件
      run: |
        cd dist
        Compress-Archive -Path "标签打印工具" -DestinationPath "LabelPrinter-Windows-x64.zip"
    
    - name: 获取版本号
      id: get_version
      run: |
        $version = "${{ github.ref_name }}"
        echo "version=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
    
    - name: 创建 Release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/LabelPrinter-Windows-x64.zip
        body: |
          ## 🏷️ 标签打印工具 ${{ steps.get_version.outputs.version }}
          
          ### 📦 下载说明
          - **Windows 用户**：下载 `LabelPrinter-Windows-x64.zip` 并解压
          - 解压后运行 `标签打印工具.exe` 即可使用
          
          ### ✨ 主要功能
          - Material Design 风格界面
          - 支持中文/泰语双语
          - PDF 预览和生成
          - 参数自动保存
          - 精致的加载动画
          
          ### 📋 更新内容
          
          #### 🎨 UI 视觉优化
          - 新增 GroupBox 边框，提升界面层次感
          - 预览区域使用渐变背景，边框加粗
          - 添加专业的加载动画（旋转指示器 + 半透明遮罩）
          
          #### 🔧 代码质量改进
          - 添加配置参数验证
          - 添加输入参数验证
          - UI 常量集中管理
          - 优化临时文件清理
          - 提取重复代码
          - 窗口缩放性能优化
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

